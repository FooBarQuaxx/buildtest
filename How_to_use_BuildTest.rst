.. _How_to_use_BuildTest:


How to use buildtest
====================


.. contents::
   :backlinks: none


If you have not completed setup your environment please :ref:`checkout the  setup. <Setup>`


Usage
-----

Let's start with the basics.

If you are unsure about buildtest see the help section (``_buildtest --help``) for more details.

.. program-output:: cat scripts/How_to_use_buildtest/buildtest-help.txt

Building the Test
-----------------

Whenever you want to build a test, check your module environment (``module av``) to find out what software package
exist on your system. Let's build test for ``GCCcore/6.4.0`` module using buildtest

.. program-output:: cat scripts/How_to_use_buildtest/example-GCCcore-6.4.0.txt



Launching Testing
-----------------
buildtest will setup your environment with ctest so you can build from out-of-source directory.
Assuming your $BUILDTEST_TESTDIR is ``/tmp/buildtest-tests``  then you can create an empty
directory called ``/tmp/build`` and run ``cmake ..`` inside the build directory
assuming their is a file ``/tmp/CMakeLists.txt`` generated by buildtest


.. program-output:: cat scripts/How_to_use_buildtest/cmake-build.txt


Afterward run ``ctest .`` to run all the tests.

.. Note:: You want to make sure you run ``ctest .`` in the build directory since ctest will
   generate bunch of scripts in the directory you ran ``cmake``


.. program-output:: cat scripts/How_to_use_buildtest/run-GCCcore-6.4.0.txt

buildtest Interactive Testing (``_buildtest run --interactive``)
------------------------------------------------------------------

buildtest comes with a menu driven test that can be used
as an alternate method to ``ctest``. Just run ``_buildtest run --interactive``
after you created a few tests and follow the prompt to navigate to
the appropriate test

.. program-output:: cat scripts/How_to_use_buildtest/runtest.txt

TAB Argument Completion
-----------------------

buildtest use the argcomplete python module to autocomplete buildtest argument.
Just press TAB key on the keyboard to fill in the arguments.

For instance if you just type ``_buildtest`` followed by TAB you should see the
following.

::

    buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest
    build                   --ebyaml                --findtest              --help                  -mns                    run                     --show-keys             -V
    --clean-logs            -fc                     -ft                     list                    --module-load-test      --scantest              --submitjob             --version
    --diff-trees            --findconfig            -h                      --logdir                --module-naming-scheme  --show                  --sysyaml

.. Note:: You will need to press the TAB key few times before it shows all the
   args

TAB completion works for choice parameters on options: ``--shell``, ``--software``,
``--toolchain``, ``--system``, ``--sysyaml``, ``--ebyaml``, ``--python-package``,
``--perl-package``, ``--r-package``, ``--ruby-package``, ``--testname``, ``--app``,
``--systempkg``

TAB complete on ``--software``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


TAB complete on ``--software`` option will present all unique software found in module tree
defined by ``BUILDTEST_MODULE_ROOT``


::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest build --software
    Display all 125 possibilities? (y or n)
    Autoconf/2.69-GCCcore-6.4.0                                 GROMACS/2016.5-intel-2018a                                  ncurses/6.0
    Automake/1.15.1-GCCcore-6.4.0                               GSL/2.4-GCCcore-6.4.0                                       ncurses/6.0-GCCcore-6.4.0
    Autotools/20170619-GCCcore-6.4.0                            Guile/1.8.8-GCCcore-6.4.0                                   netCDF/4.5.0-intel-2018a
    BamTools/2.5.1-intel-2018a                                  HDF5/1.10.1-intel-2018a                                     netCDF-Fortran/4.4.4-intel-2018a
    BEDTools/2.27.1-intel-2018a                                 help2man/1.47.4                                             nettle/3.3-GCCcore-6.4.0
    binutils/2.28                                               help2man/1.47.4-GCCcore-6.4.0                               NLopt/2.4.2-intel-2018a
   --More--

TAB complete on ``--toolchain``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TAB completion on ``--toolchain`` will present all easybuild toolchains installed
in the software stack

::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest build --toolchain
    foss/2018a                          GCCcore/6.4.0                       iccifort/2018.1.163-GCC-6.4.0-2.28  intel/2018a
    GCC/6.4.0-2.28                      gompi/2018a                         iimpi/2018a


TAB complete on ``--system``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TAB completion on ``--system`` will display all the system package that have a yaml
file typically found in directory ``$BUILDTEST_CONFIGS_REPO/system`` directory.

::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest build --system
    acl                  CentrifyDC-openssh   file                 git                  ncurses              powertop             sed                  util-linux           zip
    at                   chrony               firefox              htop                 numactl              procps-ng            singularity-runtime  wget
    atop                 coreutils            gcc                  hwloc                openssh-clients      python               strace               which
    binutils             curl                 gcc-c++              iptables             perl                 rpm                  systemd              xz
    bzip2                diffstat             gcc-gfortran         ltrace               pinfo                ruby                 time                 yum



TAB complete on ``--sysyaml``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TAB completion ``--sysyaml`` will present all system package available on your
system. If you are using Centos, RHEL, or Fedora then you will be using yum
as your package manager. This output is extracted by getting output of ``rpm -qa``

.. code::

        [siddis14@amrndhl1228 buildtest-framework]$ _buildtest --sysyaml
        Display all 1695 possibilities? (y or n)
        abattis-cantarell-fonts                         libnl3                                          python-custodia
        abrt                                            libnl3-cli                                      python-dateutil
        abrt-addon-ccpp                                 libnotify                                       python-decorator
        abrt-addon-kerneloops                           liboauth                                        python-deltarpm
        abrt-addon-pstoreoops                           libogg                                          python-devel
        abrt-addon-python                               libosinfo                                       python-dmidecode
        abrt-addon-vmcore                               libotf                                          python-dns
        abrt-addon-xorg                                 libpath_utils                                   python-enum34
        abrt-cli                                        libpcap                                         python-ethtool
        abrt-console-notification                       libpciaccess                                    python-gssapi
        --More--

TAB completion on ``--ebyaml``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Tab completion on ``--ebyaml`` will show which software packages you can generate yaml configuration
for binary test. The options are auto-populated based on modules found in BUILDTEST_MODULE_ROOT. Whenever you
you create a yaml configuration using ``--ebyaml`` such as ``_buildtest --ebyaml libGLU/9.0.0-intel-2018a`` then buildtest
will remove this entry from the list of choices to avoid buildtest from overwriting yaml configuration once it is made.


.. code::

    (buildtest) [siddis14@amrndhl1157 buildtest-framework]$ _buildtest --ebyaml lib
    libdrm/2.4.88-GCCcore-6.4.0        libharu/2.3.0-foss-2018a           libpng/1.6.32-GCCcore-6.4.0        libtool/2.4.6-GCCcore-6.4.0        libxml2/2.9.4-GCCcore-6.4.0
    libffi/3.2.1-GCCcore-6.4.0         libjpeg-turbo/1.5.2-GCCcore-6.4.0  libreadline/7.0-GCCcore-6.4.0      libunistring/0.9.7-GCCcore-6.4.0   libxsmm/1.8.3-intel-2018a
    libGLU/9.0.0-intel-2018a           libmatheval/1.1.11-GCCcore-6.4.0   libsndfile/1.0.28-GCCcore-6.4.0    libxc/3.0.1-intel-2018a

TAB completion on ``--testname``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

You can run individual test via buildtest using ``--testname`` option and this supports
tab completion.

::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest run --testname /tmp/buildtest-tests/
    Display all 296 possibilities? (y or n)
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/arglist.c.csh                                 /tmp/buildtest-tests/ebapp/Ruby/2.5.0-intel-2018a/tilt_--help.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/arglist.c.sh                                  /tmp/buildtest-tests/ebapp/Ruby/2.5.0-intel-2018a/which_htmldiff_--version.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/cpp_--version.sh                              /tmp/buildtest-tests/system/acl/_usr_bin_chacl_-l__.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/gcc-ar_-V.csh                                 /tmp/buildtest-tests/system/acl/_usr_bin_getfacl_-v.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/gcc-ar_-V.sh                                  /tmp/buildtest-tests/system/acl/_usr_bin_setfacl_-v.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/gcc-nm_-V.csh                                 /tmp/buildtest-tests/system/at/find__usr_bin_batch.sh
    /tmp/buildtest-tests/ebapp/GCCcore/6.4.0/gcc-nm_-V.sh                                  /tmp/buildtest-tests/system/at/find__usr_sbin_atd.sh

    --More--

TAB completion on ``--app``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TAB completion works on ``--app`` which return a list of software you can run tests that
were generated by ``_buildtest build -s <module>``

::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest run --app
    GCCcore/6.4.0                     Perl/5.26.0-GCCcore-6.4.0         Python/2.7.14-GCCcore-6.4.0-bare  R/3.4.3-intel-2018a-X11-20171023
    OpenMPI/3.0.0-GCC-6.4.0-2.28      Python/2.7.14-GCCcore-6.4.0       Python/2.7.14-intel-2018a         Ruby/2.5.0-intel-2018a



TAB completion on ``--systempkg``
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

TAB completion works on ``--systempkg`` which return a list of system package you can
run tests that were generated by ``_buildtest build --system <package>``

::

    (buildtest) [siddis14@adwnode1 buildtest-framework]$ _buildtest run --systempkg
    acl        at         atop       binutils   bzip2      chrony     coreutils  curl       gcc        wget


System Package Test
-------------------

buildtest can generate tests for system packages using the option ``_buildtest build --system <package>``.
Currently, system package test only perform binary test. This means you need to
find the binaries associated with the package and add the executable and any
parameters in ``command.yaml``.

This file will be ``$BUILDTEST_CONFIGS_REPO/buildtest/system/$pkg/command.yaml`` where $pkg is
name of system package. At this moment, buildtest is using Redhat package
naming convention.

For instance to build test for the system package ``gcc`` you can do the following

.. code::

   _buildtest build --system gcc


Log files
---------

All buildtest logs will be written in ``BUILDTEST_LOGDIR``.

buildtest will store log files for ``_buildtest build -s <app_name>/<app_ver>`` in
``BUILDTEST_LOGDIR/<app_name>/<app_ver>``. If toolchain option is specified for
instance ``_buildtest build -s <app_name>/<app_ver> -t <tc_name>/<tc_ver>`` then
buildtest will store the logs in ``BUILDTEST_LOGDIR/<app_name>/<app_ver>/<tc_name>/<tc_ver>``.

Similarly logs for system tests like ``_buildtest --system <package>`` will be stored in ``BUILDTEST_LOGDIR/system/<package>``

You may override BUILDTEST_LOGDIR option at command line via ``_buildtest --logdir``
and you may even store individual buildtest runs in separate directories such as
the following

.. code::

   _buildtest build -s OpenMPI/3.0.0-GCC-6.4.0-2.28 --logdir=/tmp
